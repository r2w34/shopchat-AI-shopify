{% comment %}
  AI Chat Widget Block
  Allows merchants to add AI chat support anywhere on their store
{% endcomment %}

<div 
  id="ai-chat-widget-{{ block.id }}" 
  class="ai-chat-widget-container"
  data-shop="{{ shop.permanent_domain }}"
  data-api-url="{{ block.settings.api_url }}"
  data-position="{{ block.settings.position }}"
  data-primary-color="{{ block.settings.primary_color }}"
  data-welcome-message="{{ block.settings.welcome_message }}"
  style="
    --chat-primary-color: {{ block.settings.primary_color }};
    --chat-position: {{ block.settings.position }};
  ">
</div>

<script defer crossorigin="anonymous">
(function() {
  const config = {
    shop: '{{ shop.permanent_domain }}',
    apiUrl: '{{ block.settings.api_url | default: "https://shopchatai.indigenservices.com" }}',
    position: '{{ block.settings.position }}',
    primaryColor: '{{ block.settings.primary_color }}',
    welcomeMessage: '{{ block.settings.welcome_message }}',
    offline_message: '{{ block.settings.offline_message }}',
    placeholder: '{{ block.settings.placeholder }}',
    button_text: '{{ block.settings.button_text }}'
  };

  // Set global config before loading widget
  window.AIChatConfig = config;
  console.log('✅ AIChatConfig set:', config);

  // Load widget script
  const script = document.createElement('script');
  script.src = config.apiUrl + '/chat-widget.js';
  script.async = true;
  script.onload = function() {
    console.log('✅ Chat widget script loaded');
    if (window.initAIChatWidget) {
      window.initAIChatWidget(config);
    }
  };
  script.onerror = function() {
    console.error('❌ Failed to load chat widget script from:', config.apiUrl);
  };
  document.body.appendChild(script);

  // Load widget styles
  const link = document.createElement('link');
  link.rel = 'stylesheet';
  link.href = config.apiUrl + '/chat-widget.css';
  document.head.appendChild(link);
})();
</script>

{% schema %}
{
  "name": "AI Chat Widget",
  "target": "body",
  "settings": [
    {
      "type": "text",
      "id": "api_url",
      "label": "API URL",
      "default": "https://shopchatai.indigenservices.com"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        { "value": "bottom-right", "label": "Bottom Right" },
        { "value": "bottom-left", "label": "Bottom Left" },
        { "value": "top-right", "label": "Top Right" },
        { "value": "top-left", "label": "Top Left" }
      ],
      "default": "bottom-right"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#2563eb"
    },
    {
      "type": "text",
      "id": "welcome_message",
      "label": "Welcome Message",
      "default": "Hi! How can I help you today?"
    },
    {
      "type": "text",
      "id": "offline_message",
      "label": "Offline Message",
      "default": "We're currently offline. Leave a message!"
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Input Placeholder",
      "default": "Type your message..."
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Chat Button Text",
      "default": "Chat with us"
    }
  ]
}
{% endschema %}
